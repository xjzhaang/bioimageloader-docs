<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="DL: Training Stardist and Cellpose Models" href="train_models.html" /><link rel="prev" title="DL: Deep learning with BioImage.IO" href="bioimage_io.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>DL: StarDist and Cellpose - bioimageloader</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">bioimageloader</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">bioimageloader</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides/index.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/basic0_prepare_datasets.html">Basic: Prepare datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/basic1_basic.html">Basic: Basic usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/basic2_load_multi_dsets.html">Basic: Load multiple datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/basic3_deep_learning_with_pytorch.html">Basic: Deep learning with PyTorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/more0_split.html">More: Split training/test set</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/guide_more1_speedup.html">More: Speeding up loading by pre-parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/more2_subclassing.html">More: Modifying existing collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guides/more3_custom_dataset.html">More: Writing a custom Dataset</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Notebooks</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pca.html">ML: Data statistics with PCA</a></li>
<li class="toctree-l2"><a class="reference internal" href="bioimage_io.html">DL: Deep learning with <em>BioImage.IO</em></a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">DL: StarDist and Cellpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="train_models.html">DL: Training Stardist and Cellpose Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="train_models.html#(tmp)-Setup">(tmp) Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="table.html">DL: Benchmark Table</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../catalogue/index.html">Collection Catalogue</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tips/index.html">Miscellaneous</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tips/tensorflow.html">TensorFlow installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tips/torch.html">PyTorch installation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/bioimageloader.html">bioimageloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/base.html">bioimageloader.base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/common.html">bioimageloader.common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/collections.html">bioimageloader.collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/batch.html">bioimageloader.batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">bioimageloader.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/transforms.html">bioimageloader.transforms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script>require=requirejs;</script><section id="DL:-StarDist-and-Cellpose">
<h1>DL: StarDist and Cellpose<a class="headerlink" href="#DL:-StarDist-and-Cellpose" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://github.com/stardist/stardist">StarDist</a> and <a class="reference external" href="https://github.com/mouseLand/cellpose">Cellpose</a> are the two most popular deep neural network to perform object detection and segmentation. Let’s try them out with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code>.</p>
<p>NOTE <strong>I am not trying to make a statement through this example that one model is better than the other. What I want to demonstrate here is that both models are fabulous and may or may not perform well depending on datasets.</strong></p>
<p>NOTE This notebook requires around 4GB of GPU memory if you choose to use a GPU. If your GPU cannot cope with it then try running each model separately after reinitializaing the kernel.</p>
<section id="Install-dependencies-and-Imports">
<h2>Install dependencies and Imports<a class="headerlink" href="#Install-dependencies-and-Imports" title="Permalink to this headline">#</a></h2>
<p><strong>notes about ``tensorflow``</strong></p>
<p>We need <code class="docutils literal notranslate"><span class="pre">stardist</span></code>, which can be easily installed through pip (through <a class="reference external" href="https://pypi.org/">https://pypi.org/</a>), but what’s more important is to install <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code> pkg. If you would like to use GPU, please find a <strong>guide in “Miscellaneous” -&gt;</strong><a class="reference external" href="../tips/tensorflow.html">“TensorFlow installation”</a> in <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> documentation.</p>
<p>Additionally we install <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> for plotting and <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, showing process using <code class="docutils literal notranslate"><span class="pre">tqdm</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose a GPU if you have multiple ones</span>
<span class="c1"># tensorflow tries to use all available GPU on machine by default</span>
<span class="c1"># Ignore this part if you are going to use CPU</span>
<span class="o">%</span><span class="k">env</span> CUDA_VISIBLE_DEVICES=0
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
env: CUDA_VISIBLE_DEVICES=0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># disable tf warning. Not a good idea in general</span>
<span class="c1"># I am hiding warnings for the sake of desmonstrating this notebook</span>
<span class="o">%</span><span class="k">env</span> TF_CPP_MIN_LOG_LEVEL=3
<span class="c1"># TF assigns all available GPU memory to its processes by default</span>
<span class="c1"># Come on TF seriously, we don't like this behavior and not everyone</span>
<span class="c1"># sets up a virtual machine with a limited GPU memory setting.</span>
<span class="c1"># https://github.com/tensorflow/tensorflow/issues/25138</span>
<span class="o">%</span><span class="k">env</span> TF_FORCE_GPU_ALLOW_GROWTH='true'
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
env: TF_CPP_MIN_LOG_LEVEL=3
env: TF_FORCE_GPU_ALLOW_GROWTH='true'
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #--- StarDist and Tensorflow ---# #</span>
<span class="c1"># !pip install csbdeep  # contains tools for restoration of fluorescence microcopy images (Content-aware Image Restoration, CARE). It uses Keras and Tensorflow.</span>
<span class="c1"># !pip install stardist # contains tools to operate STARDIST.</span>
<span class="c1"># !pip install gputools # improves STARDIST performances (optional)</span>
<span class="c1"># #--- Cellpose and PyTorch ---# #</span>
<span class="c1"># !pip install cellpose</span>
<span class="c1"># #--- etc ---# #</span>
<span class="c1"># !pip install matplotlib seaborn pandas tqdm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># StarDist and TensorFlow</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">stardist.models</span> <span class="kn">import</span> <span class="n">StarDist2D</span>
<span class="kn">from</span> <span class="nn">stardist.data</span> <span class="kn">import</span> <span class="n">test_image_nuclei_2d</span>
<span class="kn">from</span> <span class="nn">stardist.plot</span> <span class="kn">import</span> <span class="n">render_label</span>
<span class="kn">from</span> <span class="nn">csbdeep.utils</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">from</span> <span class="nn">stardist.matching</span> <span class="kn">import</span> <span class="n">matching</span>

<span class="c1"># Cellpose and PyTorch</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">cellpose</span> <span class="kn">import</span> <span class="n">models</span> <span class="k">as</span> <span class="n">cellpose_models</span>

<span class="c1"># bioimageloader</span>
<span class="kn">import</span> <span class="nn">albumentations</span> <span class="k">as</span> <span class="nn">A</span>
<span class="kn">from</span> <span class="nn">bioimageloader</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">BatchDataloader</span>
<span class="kn">from</span> <span class="nn">bioimageloader.transforms</span> <span class="kn">import</span> <span class="n">SqueezeGrayImageHWC</span><span class="p">,</span> <span class="n">HWCToCHW</span>
<span class="kn">from</span> <span class="nn">bioimageloader.utils</span> <span class="kn">import</span> <span class="n">random_label_cmap</span>

<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'font.size'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.interpolation'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'none'</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">random_label_cmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting 'TF_FORCE_GPU_ALLOW_GROWTH' does not actually limit</span>
<span class="c1"># gpu memory, it allows to grow. we have to manually limit memory usage</span>
<span class="k">if</span> <span class="n">gpus</span> <span class="o">:=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">'GPU'</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vdc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">VirtualDeviceConfiguration</span><span class="p">(</span>
                <span class="n">memory_limit</span><span class="o">=</span><span class="mi">2000</span>
            <span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_virtual_device_configuration</span><span class="p">(</span>
                <span class="n">gpu</span><span class="p">,</span> <span class="p">[</span><span class="n">vdc</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1"># see what devices you have (set)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[PhysicalDevice(name='/physical_device:CPU:0', device_type='CPU'), PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]
</pre></div></div>
</div>
</section>
<section id="StarDist">
<h2>StarDist<a class="headerlink" href="#StarDist" title="Permalink to this headline">#</a></h2>
<section id="Test-StarDist">
<h3>Test StarDist<a class="headerlink" href="#Test-StarDist" title="Permalink to this headline">#</a></h3>
<p>Let’s check if everything works</p>
<p>I followed this guide on github page (<a class="reference external" href="https://github.com/stardist/stardist#pretrained-models-for-2d">https://github.com/stardist/stardist#pretrained-models-for-2d</a>)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">StarDist2D</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'2D_versatile_fluo'</span><span class="p">)</span>
<span class="c1"># print info (I always like to know the details)</span>
<span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Found model '2D_versatile_fluo' for 'StarDist2D'.
Loading network weights from 'weights_best.h5'.
Loading thresholds from 'thresholds.json'.
Using default values: prob_thresh=0.479071, nms_thresh=0.3.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'n_dim': 2,
 'axes': 'YXC',
 'n_channel_in': 1,
 'n_channel_out': 33,
 'train_checkpoint': 'weights_best.h5',
 'train_checkpoint_last': 'weights_last.h5',
 'train_checkpoint_epoch': 'weights_now.h5',
 'n_rays': 32,
 'grid': (2, 2),
 'backbone': 'unet',
 'n_classes': None,
 'unet_n_depth': 3,
 'unet_kernel_size': [3, 3],
 'unet_n_filter_base': 32,
 'unet_n_conv_per_depth': 2,
 'unet_pool': [2, 2],
 'unet_activation': 'relu',
 'unet_last_activation': 'relu',
 'unet_batch_norm': False,
 'unet_dropout': 0.0,
 'unet_prefix': '',
 'net_conv_after_unet': 128,
 'net_input_shape': [None, None, 1],
 'net_mask_shape': [None, None, 1],
 'train_shape_completion': False,
 'train_completion_crop': 32,
 'train_patch_size': [256, 256],
 'train_background_reg': 0.0001,
 'train_foreground_only': 0.9,
 'train_sample_cache': True,
 'train_dist_loss': 'mae',
 'train_loss_weights': [1, 0.2],
 'train_class_weights': (1, 1),
 'train_epochs': 800,
 'train_steps_per_epoch': 400,
 'train_learning_rate': 0.0003,
 'train_batch_size': 8,
 'train_n_val_patches': None,
 'train_tensorboard': True,
 'train_reduce_lr': {'factor': 0.5, 'patience': 80, 'min_delta': 0},
 'use_gpu': False}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">test_image_nuclei_2d</span><span class="p">()</span>

<span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"input image"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">render_label</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"prediction + input overlay"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, 'prediction + input overlay')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_10_1.png" src="../_images/notebooks_benchmark_10_1.png"/>
</div>
</div>
</section>
<section id="Test-StarDist-with-bioimageloader">
<h3>Test StarDist with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code><a class="headerlink" href="#Test-StarDist-with-bioimageloader" title="Permalink to this headline">#</a></h3>
<p>Once we have a working StarDist, now it is time to have some fun with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code>!</p>
<p>We will resize images to manageable size (256, 256) and squeeze channels.</p>
<p><strong>Small but lengthy notes</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> provides a few custom transforms compatible with <code class="docutils literal notranslate"><span class="pre">albumentations</span></code> library. <code class="docutils literal notranslate"><span class="pre">SqueezeGrayImageHWC</span></code> is one of them. We already converted images to grayscale, but by default <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> keeps its dimension to 3 channels because most computer vision models expect RGB channels (read more about assumptions and decisions <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> made in the documentation). Long story short, <code class="docutils literal notranslate"><span class="pre">SqueezeGrayImageHWC</span></code> picks only one channel out of the same 3 channels.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># give a path to dataset and set grayscale=True</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DSB2018'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'root_dir'</span><span class="p">:</span> <span class="s1">'../Data/DSB2018'</span><span class="p">,</span>
        <span class="s1">'grayscale'</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">A</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
    <span class="n">SqueezeGrayImageHWC</span><span class="p">()</span>  <span class="c1"># from (3, h, w) to (1, h, w)</span>
<span class="p">])</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span><span class="si">:</span><span class="s1">10d</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
DSB2018   :        670
</pre></div></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">bioimageloader.BatchDataloader</span></code> to load data in batch</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Feel free to adjust</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">dsb2018</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">BatchDataloader</span><span class="p">(</span><span class="n">dsb2018</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                         <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">iter_loader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iter_loader</span><span class="p">)</span>

<span class="n">input_image</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
<span class="c1"># will have shape (BATCH_SIZE, 256, 256)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
    <span class="n">input_image_i</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">input_image_i</span><span class="p">)</span>
    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">'image.interpolation'</span><span class="p">:</span> <span class="s1">'none'</span><span class="p">}):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">BATCH_SIZE</span><span class="p">],</span>
                           <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'prediction'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_16_0.png" src="../_images/notebooks_benchmark_16_0.png"/>
</div>
</div>
<p>Notice how easy it was to load data and run <em>StarDist</em> on them with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code>? Let’s have some more fun.</p>
<p>*The thrid and the forth one had better be inverted. Anyway let’s keep going on.</p>
<section id="Evaluation">
<h4>Evaluation<a class="headerlink" href="#Evaluation" title="Permalink to this headline">#</a></h4>
<p>Using <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code>, we can easily iterate through all images of <em>DSB2018</em> and get metric values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># more workers and larger batch size</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">BatchDataloader</span><span class="p">(</span><span class="n">dsb2018</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                         <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">iter_loader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matching_scores</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="p">)):</span>
    <span class="n">input_image</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
    <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'mask'</span><span class="p">]</span>
    <span class="c1"># will have shape (BATCH_SIZE, 256, 256)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">input_image_i</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">gt_mask_i</span> <span class="o">=</span> <span class="n">gt_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pred_i</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">input_image_i</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">matching</span><span class="p">(</span><span class="n">gt_mask_i</span><span class="p">,</span> <span class="n">pred_i</span><span class="p">)</span>
        <span class="n">matching_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "97e26723af28441b9fc209f70099f733", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">'accuracy'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">matching_scores</span><span class="p">)),</span>
    <span class="s1">'f1'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">f1</span><span class="p">,</span> <span class="n">matching_scores</span><span class="p">)),</span>
<span class="p">})</span>
<span class="n">scores_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>accuracy</th>
<th>f1</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0.740741</td>
<td>0.851064</td>
</tr>
<tr>
<th>1</th>
<td>0.944444</td>
<td>0.971429</td>
</tr>
<tr>
<th>2</th>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>3</th>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>4</th>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>665</th>
<td>0.923077</td>
<td>0.960000</td>
</tr>
<tr>
<th>666</th>
<td>0.761905</td>
<td>0.864865</td>
</tr>
<tr>
<th>667</th>
<td>0.894737</td>
<td>0.944444</td>
</tr>
<tr>
<th>668</th>
<td>0.846154</td>
<td>0.916667</td>
</tr>
<tr>
<th>669</th>
<td>0.875000</td>
<td>0.933333</td>
</tr>
</tbody>
</table></div>
<p>670 rows × 2 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>

<span class="c1"># also known as "average precision" (?)</span>
<span class="c1"># -&gt; https://www.kaggle.com/c/data-science-bowl-2018#evaluation</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Accuracy'</span><span class="p">)</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span>
                 <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'DSB2018'</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'F-1 score'</span><span class="p">)</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'f1'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span>
                 <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">'f1'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'DSB2018'</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_22_0.png" src="../_images/notebooks_benchmark_22_0.png"/>
</div>
</div>
<p>It performs pretty well overall!</p>
</section>
</section>
<section id="Scaling-up-evaluation">
<h3>Scaling up evaluation<a class="headerlink" href="#Scaling-up-evaluation" title="Permalink to this headline">#</a></h3>
<p>We saw that iterating <em>DSB2018</em> dataset can be easily done with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code>. Likewise, it is simple to iterate all other datasets in the same steps.</p>
<p>Below, I am loading datasets that have instance segmented mask annotation, so that I can get object detection related metrics in the end. In addition, I am converting color images to grayscale with <code class="docutils literal notranslate"><span class="pre">grayscale</span></code> argument, because StarDist expects that.</p>
<p>NOTE that we are using training dataset for <em>DSB2018</em> and <em>BBBC039</em> (the others do not have splits). Take this fact into account when you analyze results below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg_all_collections</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s1">'../configs/instance_mask_collections_gray.yml'</span><span class="p">)</span>
<span class="n">cfg_all_collections</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'DSB2018': {'root_dir': '/home/seongbinlim/Data/DSB2018/', 'grayscale': True},
 'ComputationalPathology': {'root_dir': '/home/seongbinlim/Data/ComputationalPathology',
  'grayscale': True},
 'S_BSST265': {'root_dir': '/home/seongbinlim/Data/BioStudies'},
 'FRUNet': {'root_dir': '/home/seongbinlim/Data/FRU_processing'},
 'BBBC006': {'root_dir': '/home/seongbinlim/Data/bbbc/006/',
  'grayscale': True},
 'BBBC020': {'root_dir': '/home/seongbinlim/Data/bbbc/020', 'grayscale': True},
 'BBBC039': {'root_dir': '/home/seongbinlim/Data/bbbc/039'}}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">A</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
    <span class="n">SqueezeGrayImageHWC</span><span class="p">()</span>  <span class="c1"># from (h, w, 3) to (h, w)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">cfg_all_collections</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>
<span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">total_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span><span class="si">:</span><span class="s1">10d</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">{:10s}</span><span class="s1">: </span><span class="si">{:10d}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'total'</span><span class="p">,</span> <span class="n">total_len</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
DSB2018   :        670
ComPath   :         30
S_BSST265 :         79
FRUNet    :         72
BBBC006   :        768
BBBC020   :         20
BBBC039   :        150
total     :       1789
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">,</span> <span class="s1">'Accuracy'</span><span class="p">,</span> <span class="s1">'F-1'</span><span class="p">])</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Iterating:'</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">BatchDataloader</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span>
                             <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                             <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
    <span class="n">iter_loader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="p">)):</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
        <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'mask'</span><span class="p">]</span>
        <span class="c1"># will have shape (BATCH_SIZE, 256, 256)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="n">input_image_i</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">gt_mask_i</span> <span class="o">=</span> <span class="n">gt_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pred_i</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">input_image_i</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">matching</span><span class="p">(</span><span class="n">gt_mask_i</span><span class="p">,</span> <span class="n">pred_i</span><span class="p">)</span>
            <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">scores_df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">f1</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: DSB2018
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "22634922ded94c82853773fdda058b53", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: ComPath
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b8bb15fed3414da9bcd0fe8ba8671e87", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: S_BSST265
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "73d629b0fbaf4cb7b32f61a9aaf3c042", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: FRUNet
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6be1e59149014c5f8cd3dd02740ed922", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC006
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2bac8236a2104a0f9a196a3bba626f86", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC020
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9c5fd203c4154aa1adb7c91c931e6efe", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC039
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "425fff94dd7a419295a590b046c07c92", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Do some <code class="docutils literal notranslate"><span class="pre">pandas</span></code> juggling. Make each column represent a dataset and get <strong>Accuracy</strong>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pivot_scores_acc</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'Accuracy'</span><span class="p">)</span>
<span class="n">pivot_scores_acc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>Name</th>
<th>BBBC006</th>
<th>BBBC020</th>
<th>BBBC039</th>
<th>ComPath</th>
<th>DSB2018</th>
<th>FRUNet</th>
<th>S_BSST265</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.740741</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.944444</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>2</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>3</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>4</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>1784</th>
<td>NaN</td>
<td>NaN</td>
<td>0.875000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1785</th>
<td>NaN</td>
<td>NaN</td>
<td>0.778626</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1786</th>
<td>NaN</td>
<td>NaN</td>
<td>0.909091</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1787</th>
<td>NaN</td>
<td>NaN</td>
<td>0.876190</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1788</th>
<td>NaN</td>
<td>NaN</td>
<td>0.896226</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table></div>
<p>1789 rows × 7 columns</p>
</div></div>
</div>
<p>Remove NaN and serialize each column individually</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">scores_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pivot_scores_acc</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># props</span>
<span class="n">medianprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">boxprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">'-'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">meanpointprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">,</span>
                      <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span>
                      <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span>
                     <span class="p">)</span>


<span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pivot_scores_acc</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>  <span class="c1"># sns default</span>
<span class="n">mAP</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">scores_acc</span><span class="p">,</span>
           <span class="n">positions</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
           <span class="n">meanline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="n">boxprops</span><span class="p">,</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="n">medianprops</span><span class="p">,</span>
           <span class="n">meanprops</span><span class="o">=</span><span class="n">meanpointprops</span><span class="p">,</span>
          <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Accuracy'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># ax.set_ylim(bottom=0.4)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'StarDist (mAP=</span><span class="si">{</span><span class="n">mAP</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, 'StarDist (mAP=0.50)')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_33_1.png" src="../_images/notebooks_benchmark_33_1.png"/>
</div>
</div>
<p>Overall StarDist is very impressive!</p>
<p>[Some More] Accuracy (average precision) value of <em>ComPath</em> is brutal. Did we do something wrong? Check out the last section in this notebook <strong>1.4. [Some More] Fixing(?) ComPath</strong> if you are interested.</p>
</section>
</section>
<section id="Cellpose">
<h2>Cellpose<a class="headerlink" href="#Cellpose" title="Permalink to this headline">#</a></h2>
<section id="Test-Cellpose">
<h3>Test Cellpose<a class="headerlink" href="#Test-Cellpose" title="Permalink to this headline">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_cp</span> <span class="o">=</span> <span class="n">cellpose_models</span><span class="o">.</span><span class="n">Cellpose</span><span class="p">(</span>
    <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">model_type</span><span class="o">=</span><span class="s1">'nuclei'</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">test_image_nuclei_2d</span><span class="p">()</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model_cp</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7fe9c9c24520&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_39_1.png" src="../_images/notebooks_benchmark_39_1.png"/>
</div>
</div>
</section>
<section id="Evaluation-with-Cellpose-and-bioimageloader">
<h3>Evaluation with Cellpose and <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code><a class="headerlink" href="#Evaluation-with-Cellpose-and-bioimageloader" title="Permalink to this headline">#</a></h3>
<p>Below code cells are almost copy-paste form StarDist parts except for some parts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg_all_collections</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'DSB2018': {'root_dir': '/home/seongbinlim/Data/DSB2018/', 'grayscale': True},
 'ComputationalPathology': {'root_dir': '/home/seongbinlim/Data/ComputationalPathology',
  'grayscale': True},
 'S_BSST265': {'root_dir': '/home/seongbinlim/Data/BioStudies'},
 'FRUNet': {'root_dir': '/home/seongbinlim/Data/FRU_processing'},
 'BBBC006': {'root_dir': '/home/seongbinlim/Data/bbbc/006/',
  'grayscale': True},
 'BBBC020': {'root_dir': '/home/seongbinlim/Data/bbbc/020', 'grayscale': True},
 'BBBC039': {'root_dir': '/home/seongbinlim/Data/bbbc/039'}}
</pre></div></div>
</div>
<p>Cellpose expect image batch to have (b, 3, h, w) shape. Remember that <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> returns (b, h, w, 3)? We will reorder shape to match what Cellpose requires by using <code class="docutils literal notranslate"><span class="pre">bioimageloader.transforms.HWCToCHW</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">A</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
    <span class="c1"># SqueezeGrayImageHWC()  # from (h, w, 3) to (h, w)</span>
    <span class="n">HWCToCHW</span><span class="p">(),</span>  <span class="c1"># NEW, from (h, w, 3) to (3, h, w)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">cfg_all_collections</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">)</span>
<span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">total_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="si">:</span><span class="s1">10s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span><span class="si">:</span><span class="s1">10d</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">{:10s}</span><span class="s1">: </span><span class="si">{:10d}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'total'</span><span class="p">,</span> <span class="n">total_len</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
DSB2018   :        670
ComPath   :         30
S_BSST265 :         79
FRUNet    :         72
BBBC006   :        768
BBBC020   :         20
BBBC039   :        150
total     :       1789
</pre></div></div>
</div>
<p>We will go through the same steps as StarDist</p>
<p>Notice that</p>
<ul>
<li><p>Cellpose allows batch processing</p>
<p>Don’t have to iterate each entry in batch</p>
</li>
<li><p>Slower than StarDist because of <code class="docutils literal notranslate"><span class="pre">net_avg</span></code></p>
<p>You may think that batch processing should allow faster execution, but it is not because of <code class="docutils literal notranslate"><span class="pre">net_avg</span></code>. It is an ensemble idea, common in machine learning. Cellpose suggests to opt in <code class="docutils literal notranslate"><span class="pre">net_avg</span></code>, which runs 4 differenct models and aggregates their results.</p>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">,</span> <span class="s1">'Accuracy'</span><span class="p">,</span> <span class="s1">'F-1'</span><span class="p">])</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Iterating:'</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">BatchDataloader</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span>
                             <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                             <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
    <span class="n">iter_loader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="p">)):</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
        <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'mask'</span><span class="p">]</span>
        <span class="c1"># will have shape (BATCH_SIZE, 256, 256)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">pred_mask</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model_cp</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span>
                                               <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">net_avg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="n">gt_mask_i</span> <span class="o">=</span> <span class="n">gt_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pred_i</span> <span class="o">=</span> <span class="n">pred_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">matching</span><span class="p">(</span><span class="n">gt_mask_i</span><span class="p">,</span> <span class="n">pred_i</span><span class="p">)</span>
            <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">scores_df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">f1</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: DSB2018
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e3826e21b8eb4e74aaff94fc3c8c61f3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: no mask pixels found
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: ComPath
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "def05d0ad9b8462c9bdc73778ba11261", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: S_BSST265
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9113f749181240ca84fecd5163c80203", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: FRUNet
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "fdb549ab8f9948a4bc2bdc9e7bde22d8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: no mask pixels found
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC006
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a453d5b893f6477fa915c798dcca2f93", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC020
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "140353aacc8e4bbe8d7806399d8c2ad7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterating: BBBC039
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9b70e2dbe0ec43f19cffb5e146025d98", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Name</th>
<th>Accuracy</th>
<th>F-1</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>DSB2018</td>
<td>0.714286</td>
<td>0.833333</td>
</tr>
<tr>
<th>1</th>
<td>DSB2018</td>
<td>0.861111</td>
<td>0.925373</td>
</tr>
<tr>
<th>2</th>
<td>DSB2018</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>3</th>
<td>DSB2018</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>4</th>
<td>DSB2018</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>1784</th>
<td>BBBC039</td>
<td>0.791667</td>
<td>0.883721</td>
</tr>
<tr>
<th>1785</th>
<td>BBBC039</td>
<td>0.732824</td>
<td>0.845815</td>
</tr>
<tr>
<th>1786</th>
<td>BBBC039</td>
<td>0.830769</td>
<td>0.907563</td>
</tr>
<tr>
<th>1787</th>
<td>BBBC039</td>
<td>0.764151</td>
<td>0.866310</td>
</tr>
<tr>
<th>1788</th>
<td>BBBC039</td>
<td>0.828571</td>
<td>0.906250</td>
</tr>
</tbody>
</table></div>
<p>1789 rows × 3 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pivot_scores_acc</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'Accuracy'</span><span class="p">)</span>
<span class="n">pivot_scores_acc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>Name</th>
<th>BBBC006</th>
<th>BBBC020</th>
<th>BBBC039</th>
<th>ComPath</th>
<th>DSB2018</th>
<th>FRUNet</th>
<th>S_BSST265</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.714286</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.861111</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>2</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>3</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>4</th>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>1784</th>
<td>NaN</td>
<td>NaN</td>
<td>0.791667</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1785</th>
<td>NaN</td>
<td>NaN</td>
<td>0.732824</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1786</th>
<td>NaN</td>
<td>NaN</td>
<td>0.830769</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1787</th>
<td>NaN</td>
<td>NaN</td>
<td>0.764151</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1788</th>
<td>NaN</td>
<td>NaN</td>
<td>0.828571</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table></div>
<p>1789 rows × 7 columns</p>
</div></div>
</div>
<p>Remove NaN and serialize each column individually</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">scores_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pivot_scores_acc</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># props</span>
<span class="n">medianprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">boxprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">'-'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">meanpointprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">,</span>
                      <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span>
                      <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span>
                     <span class="p">)</span>


<span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pivot_scores_acc</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>  <span class="c1"># sns default</span>
<span class="n">mAP</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">scores_acc</span><span class="p">,</span>
           <span class="n">positions</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
           <span class="n">meanline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="n">boxprops</span><span class="p">,</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="n">medianprops</span><span class="p">,</span>
           <span class="n">meanprops</span><span class="o">=</span><span class="n">meanpointprops</span><span class="p">,</span>
          <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Accuracy'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scores_df</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># ax.set_ylim(bottom=0.4)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Cellpose (mAP=</span><span class="si">{</span><span class="n">mAP</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, 'Cellpose (mAP=0.34)')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_51_1.png" src="../_images/notebooks_benchmark_51_1.png"/>
</div>
</div>
<p>Again as I mentioned at the beginning of this notbook, there is no winner! Cellpose does better in some cases and does not in others. Depending on your images and tasks, you decide which to use, what pre-/post-processes are needed on top of that, how to normalize your data so that they get fit to these models, etc.</p>
<p>You definitely want to analyze and get statistics of your data before you do anything on them, and now you have <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code> that could make all these steps so much easier and much painless!</p>
</section>
</section>
<section id="[Some-More]-Fixing(?)-ComPath">
<h2>[Some More] Fixing(?) <em>ComPath</em><a class="headerlink" href="#[Some-More]-Fixing(?)-ComPath" title="Permalink to this headline">#</a></h2>
<p>This <a class="reference external" href="../_static/table_maskdataset.html">overview table</a> is a helpful one. You could see from the sample images that <em>ComPath</em> is, first of all, H&amp;E histopathology images, which are distinct from the others. And images are dense and have high resolution (1000, 1000). So resizing them to (256, 256) may have not been a wise choice for <em>ComPath</em>.</p>
<p>Let’s define a new set of transforms for <em>ComPath</em>. We are going to do two things:</p>
<ol class="arabic">
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">Resize()</span></code> so that <em>StarDist</em> processes large dense images of <em>ComPath</em></p>
<p><em>StarDist</em> is a family of FCN (Fully Connected Neural network), which has size-invariant property meaning that it can take any size of input and return ouput whose size is the same as that of input. So we can just get rid of Resize.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">albumentation.InvertImg(p=1.0)</span></code></p>
<p>It will invert pixel values with 100% probability (<code class="docutils literal notranslate"><span class="pre">p=1.0</span></code>). It will make H&amp;E stained images look more like the rest.</p>
</li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg_all_collections</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{'DSB2018': {'root_dir': '/home/seongbinlim/Data/DSB2018/', 'grayscale': True},
 'ComputationalPathology': {'root_dir': '/home/seongbinlim/Data/ComputationalPathology',
  'grayscale': True},
 'S_BSST265': {'root_dir': '/home/seongbinlim/Data/BioStudies'},
 'FRUNet': {'root_dir': '/home/seongbinlim/Data/FRU_processing'},
 'BBBC006': {'root_dir': '/home/seongbinlim/Data/bbbc/006/',
  'grayscale': True},
 'BBBC020': {'root_dir': '/home/seongbinlim/Data/bbbc/020', 'grayscale': True},
 'BBBC039': {'root_dir': '/home/seongbinlim/Data/bbbc/039'}}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">A</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
    <span class="n">SqueezeGrayImageHWC</span><span class="p">()</span>  <span class="c1"># from (h, w, 3) to (h, w)</span>
<span class="p">])</span>
<span class="n">transforms_compath</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">A</span><span class="o">.</span><span class="n">InvertImg</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
    <span class="n">SqueezeGrayImageHWC</span><span class="p">()</span>  <span class="c1"># from (h, w, 3) to (h, w)</span>
<span class="p">])</span>

<span class="n">cfg_transforms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DSB2018'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
    <span class="s1">'ComputationalPathology'</span><span class="p">:</span> <span class="n">transforms_compath</span><span class="p">,</span>  <span class="c1"># needs extra care</span>
    <span class="s1">'S_BSST265'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
    <span class="s1">'FRUNet'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
    <span class="s1">'BBBC006'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
    <span class="s1">'BBBC020'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
    <span class="s1">'BBBC039'</span><span class="p">:</span> <span class="n">transforms</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we only need ComPath</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">cfg_all_collections</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">transforms</span><span class="o">=</span><span class="n">cfg_transforms</span><span class="p">)</span>
<span class="n">dset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ComPath
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">fix_scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">,</span> <span class="s1">'Accuracy'</span><span class="p">,</span> <span class="s1">'F-1'</span><span class="p">])</span>
<span class="c1"># for dset in datasets:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">BatchDataloader</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                         <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">iter_loader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iter_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="p">)):</span>
    <span class="n">input_image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
    <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'mask'</span><span class="p">]</span>
    <span class="c1"># will have shape (BATCH_SIZE, 256, 256)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">input_image_i</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">gt_mask_i</span> <span class="o">=</span> <span class="n">gt_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pred_i</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">input_image_i</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">matching</span><span class="p">(</span><span class="n">gt_mask_i</span><span class="p">,</span> <span class="n">pred_i</span><span class="p">)</span>
        <span class="n">fix_scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fix_scores_df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">f1</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ComPath
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "12c7e296b4aa4507bd6fd9d3933c8ba3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beforefix_scores</span> <span class="o">=</span> <span class="n">pivot_scores_acc</span><span class="p">[</span><span class="s1">'ComPath'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">beforefix_scores</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="c1"># before, almost all values were close to zero</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0    0.0
1    0.0
2    0.0
3    0.0
4    0.0
Name: ComPath, dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fix_scores_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="c1"># new metrics look much better. they are not zeros!</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<div class="table-wrapper"><table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Name</th>
<th>Accuracy</th>
<th>F-1</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>ComPath</td>
<td>0.382353</td>
<td>0.553191</td>
</tr>
<tr>
<th>1</th>
<td>ComPath</td>
<td>0.394756</td>
<td>0.566057</td>
</tr>
<tr>
<th>2</th>
<td>ComPath</td>
<td>0.348028</td>
<td>0.516351</td>
</tr>
<tr>
<th>3</th>
<td>ComPath</td>
<td>0.133023</td>
<td>0.234811</td>
</tr>
<tr>
<th>4</th>
<td>ComPath</td>
<td>0.093212</td>
<td>0.170528</td>
</tr>
</tbody>
</table></div>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># props</span>
<span class="n">medianprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">boxprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">'-'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">meanpointprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">,</span>
                      <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span>
                      <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span>
                     <span class="p">)</span>



<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># sns default</span>
<span class="c1"># mAP = scores_df.Accuracy.mean()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">beforefix_scores</span><span class="p">,</span>
           <span class="n">positions</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
           <span class="n">meanline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="n">boxprops</span><span class="p">,</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="n">medianprops</span><span class="p">,</span>
           <span class="n">meanprops</span><span class="o">=</span><span class="n">meanpointprops</span><span class="p">,</span>
          <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">beforefix_scores</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Accuracy'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Before Fix'</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">fix_scores_df</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">,</span>
           <span class="n">positions</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
           <span class="n">meanline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="n">boxprops</span><span class="p">,</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="n">medianprops</span><span class="p">,</span>
           <span class="n">meanprops</span><span class="o">=</span><span class="n">meanpointprops</span><span class="p">,</span>
          <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Accuracy'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">fix_scores_df</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'After Fix'</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">'ComPath'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, 'ComPath')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_60_1.png" src="../_images/notebooks_benchmark_60_1.png"/>
</div>
</div>
<p>We can visualize actual predictions</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sample first two paris</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'mask'</span><span class="p">]</span>
    <span class="n">pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_instances</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">matching</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">'image.interpolation'</span><span class="p">:</span> <span class="s1">'none'</span><span class="p">}):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'ComPath(</span><span class="si">{</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span><span class="si">}</span><span class="s1">) (accuracy: </span><span class="si">{</span><span class="n">score</span><span class="o">.</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Input image'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Ground truth'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'StarDist prediction'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_62_0.png" src="../_images/notebooks_benchmark_62_0.png"/>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_benchmark_62_1.png" src="../_images/notebooks_benchmark_62_1.png"/>
</div>
</div>
<p>We fixed(?) it from almost zero prediction!</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="train_models.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">DL: Training Stardist and Cellpose Models</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="bioimage_io.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">DL: Deep learning with <em>BioImage.IO</em></div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Seongbin Lim
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/LaboratoryOpticsBiosciences/bioimageloader" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">DL: StarDist and Cellpose</a><ul>
<li><a class="reference internal" href="#Install-dependencies-and-Imports">Install dependencies and Imports</a></li>
<li><a class="reference internal" href="#StarDist">StarDist</a><ul>
<li><a class="reference internal" href="#Test-StarDist">Test StarDist</a></li>
<li><a class="reference internal" href="#Test-StarDist-with-bioimageloader">Test StarDist with <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code></a><ul>
<li><a class="reference internal" href="#Evaluation">Evaluation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Scaling-up-evaluation">Scaling up evaluation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Cellpose">Cellpose</a><ul>
<li><a class="reference internal" href="#Test-Cellpose">Test Cellpose</a></li>
<li><a class="reference internal" href="#Evaluation-with-Cellpose-and-bioimageloader">Evaluation with Cellpose and <code class="docutils literal notranslate"><span class="pre">bioimageloader</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#[Some-More]-Fixing(?)-ComPath">[Some More] Fixing(?) <em>ComPath</em></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>